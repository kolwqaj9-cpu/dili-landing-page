# PropKit 完整自动化验证流程说明

## 🎯 验证目标

完整验证从访客点击到最终结果显示的整个流程：

1. ✅ **访客操作**：点击"购买"按钮（实际是免费试用，不触发支付）
2. ✅ **触发计算**：通过 webhook API 触发本地 GPU 计算
3. ✅ **CUDA 计算**：本地 RTX 3090 执行计算
4. ✅ **生成 JSON**：转换计算结果为 JSON 格式
5. ✅ **上传数据**：将 JSON 上传到 Supabase
6. ✅ **Dashboard 渲染**：浏览器从 Supabase 读取并渲染数据
7. ✅ **结果验证**：验证显示的数据确实是计算的结果

---

## 🚀 快速开始

### 前置条件

1. **服务必须运行**
   - Cloudflared 隧道
   - Python 后端

2. **启动服务**
   ```cmd
   双击: 快速启动.bat
   ```
   或
   ```cmd
   双击: 启动服务.bat
   ```

### 运行完整验证

**双击运行：`运行完整验证.bat`**

---

## 📋 验证流程详解

### Step 1: 检查服务状态

**自动检查：**
- ✅ Cloudflared 进程是否运行
- ✅ Python 后端进程是否运行
- ✅ API 是否可访问

**如果失败：**
- 运行 `快速启动.bat` 启动服务
- 等待 15-30 秒让服务初始化

---

### Step 2: 模拟访客操作

**自动执行：**
- 生成唯一测试邮箱：`auto_test_[timestamp]@verification.com`
- 直接调用 webhook API（模拟点击按钮）
- **不触发支付链接**，直接激活免费试用

**关键点：**
- ✅ 不打开支付页面
- ✅ 直接调用 API
- ✅ 立即激活免费试用

---

### Step 3: 等待计算完成

**监控过程：**
- 每 3 秒检查一次 Supabase
- 等待数据出现（最多 180 秒）
- 显示等待进度

**预期时间线：**
- Webhook 调用：立即
- GPU 计算开始：1-2 秒
- GPU 计算完成：30-120 秒
- JSON 导出：1-2 秒
- Supabase 上传：1-2 秒
- **总计：35-125 秒**

---

### Step 4: 验证计算结果

**自动验证：**
1. ✅ **数据完整性**
   - 总分析数 > 0
   - 目标数 > 0
   - 数据点数量 > 0

2. ✅ **数据格式**
   - 数据点格式正确
   - JSON 结构完整

3. ✅ **数值范围验证**
   - 总分析数：280,000 - 300,000（预期）
   - 目标数：20,000 - 30,000（预期）

4. ✅ **数据一致性**
   - 数据点数量 = 目标数
   - 数据逻辑正确

**通过标准：**
- 80% 以上检查通过 → 验证成功

---

### Step 5: 验证 Dashboard 显示

**自动执行：**
- 打开浏览器（无头模式）
- 访问 dashboard URL
- 检查页面元素
- 验证数据是否显示

**验证项：**
- ✅ 页面正常加载
- ✅ 图表元素存在
- ✅ 数据在页面中

---

## ✅ 验证成功标准

完整验证成功的标志：

- [x] 服务正常运行
- [x] Webhook 调用成功
- [x] GPU 计算完成（在 180 秒内）
- [x] JSON 数据生成
- [x] 数据上传到 Supabase
- [x] 数据验证通过（80%+ 检查通过）
- [x] Dashboard 可以访问

---

## 📊 验证结果示例

### 成功示例

```
============================================================
  Verification Summary
============================================================

  Test Email: auto_test_1770123456@verification.com
  Computation: [OK]
  Result Verification: [OK]
  Dashboard Display: [OK]
  
  Overall Result: [SUCCESS]
  
  ✅ Complete verification PASSED!
  Dashboard URL: https://propkitai.tech/dashboard.html?email=...
```

### 失败示例

```
  Computation: [FAIL] - Timeout after 180 seconds
  Result Verification: [FAIL] - No data found
  Overall Result: [FAIL]
  
  ❌ Complete verification FAILED!
```

---

## 🔧 故障排查

### 问题 1: 服务未运行

**错误：**
```
[FAIL] Cloudflared is NOT running
[FAIL] Python backend is NOT running
```

**解决：**
1. 运行 `快速启动.bat`
2. 等待 15-30 秒
3. 再次运行验证

---

### 问题 2: 计算超时

**错误：**
```
[FAIL] Timeout after 180 seconds
```

**可能原因：**
- GPU 计算时间过长
- export_json.py 执行失败
- Supabase 上传失败

**解决：**
1. 检查 Python 后端窗口的日志
2. 检查 `static/tactical_data.json` 是否生成
3. 运行 `test_local_compute.py` 测试本地计算
4. 运行 `test_upload.py` 测试上传

---

### 问题 3: 数据验证失败

**错误：**
```
[FAIL] Verification failed! (60% checks passed)
```

**可能原因：**
- 数据格式不正确
- 数值范围异常
- 数据不完整

**解决：**
1. 检查 Supabase 中的数据
2. 查看 JSON 文件内容
3. 检查计算逻辑

---

### 问题 4: Dashboard 验证失败

**错误：**
```
[WARN] Browser verification failed
```

**说明：**
- 这是可选验证
- 如果数据验证通过，不影响整体结果
- 可能是浏览器驱动问题

**解决：**
- 手动访问 dashboard URL 验证
- 检查浏览器控制台

---

## 📝 验证报告

每次验证会生成：

1. **测试邮箱**：用于追踪
2. **时间戳**：开始和结束时间
3. **各步骤状态**：成功/失败
4. **数据统计**：计算结果摘要
5. **Dashboard URL**：可直接访问

---

## 🎯 使用场景

### 1. 开发测试
- 每次代码修改后运行
- 确保功能正常

### 2. 部署前验证
- 部署到生产前运行
- 确保完整流程正常

### 3. 定期检查
- 定期运行验证
- 确保服务稳定

---

## 💡 最佳实践

1. **每次验证前重启服务**
   - 确保干净的环境
   - 避免残留数据影响

2. **使用唯一邮箱**
   - 每次自动生成
   - 便于追踪和调试

3. **监控验证时间**
   - 记录正常耗时
   - 发现异常及时排查

4. **保存验证日志**
   - 记录成功/失败
   - 便于问题分析

---

## 🚀 现在开始

1. **确保服务运行**
   ```cmd
   双击: 快速启动.bat
   ```

2. **运行完整验证**
   ```cmd
   双击: 运行完整验证.bat
   ```

3. **查看验证结果**
   - 等待验证完成
   - 查看最终报告

---

**验证成功后，整个流程就完全打通了！** 🎉

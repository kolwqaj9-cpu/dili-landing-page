<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropKit Admin Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #000; color: #fff; font-family: 'Courier New', monospace; }
        .stat-card { border: 1px solid #333; padding: 24px; border-radius: 12px; }
        .highlight { color: #facc15; }
    </style>
</head>
<body class="p-8">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-2 text-center">Command Center</h1>
        <p class="text-gray-400 text-center mb-8">Real-time Traffic & Sales Tracking</p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="stat-card">
                <p class="text-xs text-gray-400 uppercase tracking-widest mb-2">TOTAL PAGE HITS (PV)</p>
                <h2 class="text-6xl font-bold" id="pv-count">--</h2>
                <p class="text-gray-500 text-sm mt-2">Traffic Intensity</p>
            </div>
            
            <div class="stat-card border-yellow-900 bg-yellow-900/10">
                <p class="text-xs text-yellow-500 uppercase tracking-widest mb-2">TOTAL SALES (LEADS)</p>
                <h2 class="text-6xl font-bold highlight" id="sales-count">Loading...</h2>
                <p class="text-yellow-600/70 text-sm mt-2">Real-time from Supabase</p>
            </div>
        </div>

        <div class="stat-card">
            <h3 class="font-bold mb-4 flex items-center">
                <span class="mr-2">ðŸ§®</span> CONVERSION RATE
            </h3>
            
            <div class="flex items-center justify-between text-2xl">
                <div>
                    <span id="calc-sales" class="text-white font-bold">0</span> 
                    <span class="text-gray-500 text-base">Sales</span>
                </div>
                <div class="text-gray-600">/</div>
                <div>
                    <span id="calc-pv" class="text-white font-bold">--</span>
                    <span class="text-gray-500 text-base">PV</span>
                </div>
                <div class="text-gray-600">=</div>
                <div class="text-4xl font-bold text-green-500" id="conversion-rate">0.0%</div>
            </div>
        </div>
    </div>

    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <div style="display:none"><span id="busuanzi_container_site_pv"></span><span id="busuanzi_value_site_pv"></span></div>

    <script>
        // 1. é…ç½® Supabase
        const SUPABASE_URL = 'https://bmwfnuekfgolwutnffmf.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_vk9QyXdw-wB1YR41PKVBXA_YyfEyW_N';
        const supabaseClient = (typeof window.supabase !== 'undefined' && window.supabase.createClient)
            ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)
            : null;

        // 2. æ ¸å¿ƒå‡½æ•°ï¼šèŽ·å–é”€é‡å¹¶æ›´æ–°é¡µé¢
        async function fetchStats() {
            try {
                if (!supabaseClient) {
                    document.getElementById('sales-count').innerText = 'Supabase Err';
                    return;
                }

                const { data: count, error } = await supabaseClient.rpc('get_sales_count');
                
                if (error) throw error;

                const salesNum = count !== null && count !== undefined ? count : 0;
                document.getElementById('sales-count').innerText = salesNum;
                document.getElementById('calc-sales').innerText = salesNum;

                checkBusuanzi(salesNum);

            } catch (err) {
                console.error('èŽ·å–é”€é‡å¤±è´¥:', err);
                document.getElementById('sales-count').innerText = 'Err';
            }
        }

        // 3. è¾…åŠ©å‡½æ•°ï¼šä»Ž Busuanzi èŽ·å– PVï¼Œè®¡ç®—è½¬åŒ–çŽ‡
        function checkBusuanzi(sales) {
            let attempts = 0;
            const interval = setInterval(function() {
                const pvEl = document.getElementById('busuanzi_value_site_pv');
                let pv = 0;
                if (pvEl && pvEl.innerText && pvEl.innerText !== '--' && pvEl.innerText !== '...') {
                    pv = parseInt(pvEl.innerText, 10) || 0;
                }
                
                document.getElementById('pv-count').innerText = pv > 0 ? pv : '--';
                document.getElementById('calc-pv').innerText = pv > 0 ? pv : '--';

                if (pv > 0) {
                    const rate = (sales / pv * 100).toFixed(2);
                    document.getElementById('conversion-rate').innerText = rate + '%';
                    clearInterval(interval);
                }
                
                attempts++;
                if (attempts > 20) {
                    if (pv === 0) {
                        document.getElementById('pv-count').innerText = '--';
                        document.getElementById('conversion-rate').innerText = '--';
                    }
                    clearInterval(interval);
                }
            }, 500);
        }

        fetchStats();
    </script>
</body>
</html>
